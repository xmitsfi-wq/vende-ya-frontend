<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VENDE YA! | Classifieds</title>
    <style>
        :root { --main: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 10%; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 50; }
        .logo { font-size: 26px; font-weight: bold; color: var(--main); letter-spacing: -1px; }
        nav a { margin-left: 15px; text-decoration: none; color: #666; cursor: pointer; font-size: 14px; font-weight: 500; transition: 0.3s; }
        nav a:hover { color: var(--main); }

        .container { width: 90%; max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 25px rgba(0,0,0,0.07); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-size: 12px; color: #888; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .thumb-col { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; background: #eee; }
        .title-link { color: #2980b9; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 16px; }
        .title-link:hover { text-decoration: underline; }
        
        .btn-post { display: block; width: 220px; margin: 20px auto; padding: 14px; background: var(--main); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: transform 0.2s; }
        .btn-post:hover { transform: scale(1.03); background: #219150; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); }
        .modal-content { background: white; width: 90%; max-width: 450px; margin: 5% auto; padding: 30px; border-radius: 15px; position: relative; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-img { width: 100%; height: 250px; object-fit: cover; border-radius: 10px; margin-bottom: 15px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        
        .status-msg { text-align: center; padding: 40px; color: #666; font-style: italic; }
    </style>
</head>
<body>

<header>
    <div class="logo">VENDE YA!</div>
    <nav>
        <a onclick="fetchListings('Electronics')">Electronics</a>
        <a onclick="fetchListings('Vehicles')">Vehicles</a>
        <a onclick="fetchListings('Fashion')">Fashion</a>
        <a onclick="fetchListings('Services')">Services</a>
        <a onclick="fetchListings('Jobs')">Jobs</a>
        <a onclick="fetchListings('')" style="color: var(--main); font-weight: bold;">View All</a>
    </nav>
</header>

<div class="container">
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Image</th>
                <th>Title</th>
                <th>Category</th>
                <th>Price</th>
            </tr>
        </thead>
        <tbody id="listings-body">
            </tbody>
    </table>
    <button class="btn-post" onclick="document.getElementById('postModal').style.display='block'">+ CREATE NEW POST</button>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span onclick="this.parentElement.parentElement.style.display='none'" style="float:right; cursor:pointer; font-size: 24px;">&times;</span>
        <img id="d-img" src="" class="modal-img">
        <h2 id="d-title" style="margin-top:0;"></h2>
        <p><strong>Price:</strong> <span id="d-price" style="color: var(--main); font-size: 18px;"></span></p>
        <p><strong>Contact:</strong> <span id="d-phone"></span></p>
        <p><strong>Location:</strong> <span id="d-addr"></span></p>
        <hr style="border: 0; border-top: 1px solid #eee;">
        <p id="d-desc" style="color:#555; line-height:1.6;"></p>
    </div>
</div>

<div id="postModal" class="modal">
    <div class="modal-content">
        <h3>Post New Ad</h3>
        <input type="text" id="p-title" placeholder="What are you selling?">
        <select id="p-cat">
            <option>Electronics</option><option>Vehicles</option>
            <option>Fashion</option><option>Services</option><option>Jobs</option>
        </select>
        <input type="text" id="p-price" placeholder="Price (e.g. $50)">
        <input type="text" id="p-phone" placeholder="Phone Number">
        <input type="text" id="p-addr" placeholder="City / Address">
        <textarea id="p-desc" placeholder="Describe your item..." rows="4"></textarea>
        <input type="text" id="p-img" placeholder="Image URL (Link)">
        
        <button class="btn-post" id="submit-btn" onclick="submitPost()">SUBMIT POST</button>
        <button onclick="document.getElementById('postModal').style.display='none'" style="width:100%; background:none; border:none; color:gray; cursor:pointer; margin-top:10px;">Cancel</button>
    </div>
</div>

<script>
    const API_URL = "https://vende-ya-backend.onrender.com";

    async function fetchListings(cat = '') {
        const tbody = document.getElementById('listings-body');
        tbody.innerHTML = '<tr><td colspan="5" class="status-msg">Connecting to server... Please wait 30 seconds if first load.</td></tr>';

        try {
            const res = await fetch(`${API_URL}/api/listings${cat ? '?category='+cat : ''}`);
            const data = await res.json();
            
            tbody.innerHTML = ''; 

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="status-msg">No listings found in this category.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-size: 13px; color: #888;">${item.date}</td>
                    <td><img src="${item.image_url}" class="thumb-col" onerror="this.src='https://via.placeholder.com/150?text=No+Image'"></td>
                    <td><a class="title-link">${item.title}</a></td>
                    <td><span style="background:#eee; padding:4px 8px; border-radius:4px; font-size:12px;">${item.category}</span></td>
                    <td><strong style="color: var(--main);">${item.price}</strong></td>
                `;
                row.querySelector('.title-link').onclick = () => showPop(item);
                tbody.appendChild(row);
            });
        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="5" class="status-msg" style="color:red;">Server is currently sleeping. Please refresh in 30 seconds.</td></tr>';
        }
    }

    async function submitPost() {
        const btn = document.getElementById('submit-btn');
        const payload = {
            title: document.getElementById('p-title').value,
            category: document.getElementById('p-cat').value,
            price: document.getElementById('p-price').value,
            phone: document.getElementById('p-phone').value,
            address: document.getElementById('p-addr').value,
            description: document.getElementById('p-desc').value,
            image_url: document.getElementById('p-img').value || 'https://via.placeholder.com/150?text=No+Image'
        };

        if (!payload.title || !payload.price) return alert("Title and Price are required!");

        btn.innerText = "Posting...";
        btn.disabled = true;

        try {
            await fetch(`${API_URL}/api/post`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            document.getElementById('postModal').style.display = 'none';
            // Clear inputs
            document.querySelectorAll('#postModal input, #postModal textarea').forEach(i => i.value = '');
            fetchListings(); 
        } catch (e) {
            alert("Error posting ad. Try again.");
        } finally {
            btn.innerText = "SUBMIT POST";
            btn.disabled = false;
        }
    }

    function showPop(item) {
        document.getElementById('d-title').innerText = item.title;
        document.getElementById('d-price').innerText = item.price;
        document.getElementById('d-phone').innerText = item.phone;
        document.getElementById('d-addr').innerText = item.address;
        document.getElementById('d-desc').innerText = item.description;
        document.getElementById('d-img').src = item.image_url;
        document.getElementById('detailsModal').style.display = 'block';
    }

    // Start
    fetchListings();
</script>

</body>
</html>
